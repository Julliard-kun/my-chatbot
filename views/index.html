<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>My Chatbot</title>
        <link rel="stylesheet" href="/assets/css/index.css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <link rel="icon" type="image/x-icon" href="/assets/images/favicon.png">
    </head>

    <body>
        <div class="chatbot-container">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-robot"></i>
                    <h1>My Chatbot</h1>
                </div>
                <div class="chat-status">
                    <span class="status-indicator online"></span>
                    <span>Online</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <p>Hello! I'm your AI assistant. How can I help you today?</p>
                        <span class="message-time" id="currentTimestamp"></span>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" id="messageInput" placeholder="Type your message here..." maxlength="500">
                    <button id="sendButton" class="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="input-footer">
                    <span class="char-count">0/500</span>
                </div>
            </div>
        </div>

        <script src="/assets/js/index.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                getCurrentTimestamp();
            });
        </script>

        <script>
            document.getElementById('sendButton').addEventListener('click', () => {
                sendMessage();

                async function sendMessage() {
                    const messageInput = document.getElementById('messageInput');
                    const chatMessages = document.getElementById('chatMessages');
                    
                    console.log('sendMessage function called');
                    const userMessage = messageInput.value;
                    if (!userMessage) return;

                    messageInput.disabled = true;
                    messageInput.value = '';
                    document.getElementById('sendButton').disabled = true;

                    chatMessages.insertAdjacentHTML('beforeend', `
                        <div class="message user-message">
                            <div class="message-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="message-content">
                                <p>${userMessage}</p>
                                <span class="message-time">${getCurrentTimestampText()}</span>
                            </div>
                        </div>
                    `);

                    const typingId = `typing-${Date.now()}`;
                    chatMessages.insertAdjacentHTML('beforeend', `
                        <div class="typing-indicator" id="${typingId}">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="typing-dots">
                                <span class="typing-dot"></span>
                                <span class="typing-dot"></span>
                                <span class="typing-dot"></span>
                            </div>
                        </div>
                    `);

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ messageInput: userMessage })
                            

                    });

                    const data = await response.json();
                    const typingEl = document.getElementById(typingId);
                    if (typingEl) typingEl.remove();
                    chatMessages.insertAdjacentHTML('beforeend', `
                        <div class="message bot-message">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <p>${(data && data.replay) ? data.replay : 'No response'}</p>
                                <span class="message-time">${getCurrentTimestampText()}</span>
                            </div>
                        </div>
                    `);

                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    document.getElementById('sendButton').disabled = false;

                }
            });
        </script>
    </body>
</html>